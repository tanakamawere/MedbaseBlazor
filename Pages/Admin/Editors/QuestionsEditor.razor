@page "/admin/questions/edit/{id:int}"
@page "/admin/questions/editfromtopic/{topicId:int}"
@page "/admin/question/add"
@layout AdminLayout
@inject IApiRepository repository
@inject ISnackbar Snackbar
@using MedbaseComponents.Models
@using MedbaseBlazor.Pages.Admin.Utilities
@using Markdig


@if (Question is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row">
        <div class="col-4">
            <button @onclick="() => ClearFields()" class="btn btn-primary">Clear Form</button>
        </div>
        <div class="col-8">
            <div class="col-form-label">
                <label>Course</label>
                <select @onchange="GetCourseTopics">
                    @foreach (Course item in Courses)
                    {
                        <option value="@item.CourseRef">@item.Title</option>
                    }
                </select>
            </div>
        </div>
    </div>
    <EditForm Model="Question" OnSubmit="SaveChanges">
        <DataAnnotationsValidator />
        <div class="row">
            <div class="col-6">
                <MudSelect Label="Topic" @bind-Value="Question.TopicRef">
                    @foreach (Topic item in Topics)
                    {
                        <MudSelectItem Value="@item.TopicRef">@item.Name</MudSelectItem>
                    }
                </MudSelect>
            </div>
            <div class="col-6">
                <MudTextField Label="Question Main" @bind-Value="Question.QuestionMain" />
            </div>
        </div>
        <hr />

        <div class="container">
            <!--Child A-->
            <MudTextField T="string" Variant="Variant.Filled" Lines="2" Label="Child A" @bind-Value="Question.ChildA" />
            <div class="row text-center">
                <div class="col-4 col-sm-4 col-md-4">
                    <MudSelect Label="Answer A" @bind-Value="Question.AnswerA">
                        <MudSelectItem Value="true">True</MudSelectItem>
                        <MudSelectItem Value="false">False</MudSelectItem>
                    </MudSelect>
                </div>
                <div class="col-8 col-sm-8 col-md-8">
                    <MarkdownTextInput Variant="Variant.Outlined" Lines="3" Label="Explanation A (Markdown)" @bind-Value="Question.ExplanationA" />
                </div>
            </div>
            <hr />

            <!--Child B-->
            <MudTextField T="string" Variant="Variant.Filled" Lines="2" Label="Child B" @bind-Value="Question.ChildB" />
            <div class="row text-center">
                <div class="col-4 col-sm-4 col-md-4">
                    <MudSelect Label="Answer B" @bind-Value="Question.AnswerB">
                        <MudSelectItem Value="true">True</MudSelectItem>
                        <MudSelectItem Value="false">False</MudSelectItem>
                    </MudSelect>
                </div>
                <div class="col-8 col-sm-8 col-md-8">
                    <MarkdownTextInput Variant="Variant.Outlined" Lines="3" Label="Explanation B (Markdown)" @bind-Value="Question.ExplanationB" />
                </div>
            </div>

            <hr />
            <!--Child C-->

            <MudTextField T="string" Variant="Variant.Filled" Lines="2" Label="Child C" @bind-Value="Question.ChildC" />
            <div class="row text-center">
                <div class="col-4 col-sm-4 col-md-4">
                    <MudSelect Label="Answer C" @bind-Value="Question.AnswerC">
                        <MudSelectItem Value="true">True</MudSelectItem>
                        <MudSelectItem Value="false">False</MudSelectItem>
                    </MudSelect>
                </div>
                <div class="col-8 col-sm-8 col-md-8">
                    <MarkdownTextInput Variant="Variant.Outlined" Lines="3" Label="Explanation C (Markdown)" @bind-Value="Question.ExplanationC" />
                </div>
            </div>

            <hr />
            <!--Child D-->
            <MudTextField T="string" Variant="Variant.Filled" Lines="2" Label="Child D" @bind-Value="Question.ChildD" />
            <div class="row text-center">
                <div class="col-4 col-sm-4 col-md-4">
                    <MudSelect Label="Answer D" @bind-Value="Question.AnswerD">
                        <MudSelectItem Value="true">True</MudSelectItem>
                        <MudSelectItem Value="false">False</MudSelectItem>
                    </MudSelect>
                </div>
                <div class="col-8 col-sm-8 col-md-8">
                    <MarkdownTextInput Variant="Variant.Outlined" Lines="3" Label="Explanation D (Markdown)" @bind-Value="Question.ExplanationD" />
                </div>
            </div>
            <hr/>

            <!--Child E-->
            <MudTextField T="string" Variant="Variant.Filled" Lines="2" Label="Child E" @bind-Value="Question.ChildE" />
            <div class="row text-center">
                <div class="col-4 col-sm-4 col-md-4">
                    <MudSelect Label="Answer E" @bind-Value="Question.AnswerE">
                        <MudSelectItem Value="true">True</MudSelectItem>
                        <MudSelectItem Value="false">False</MudSelectItem>
                    </MudSelect>
                </div>
                <div class="col-8 col-sm-8 col-md-8">
                    <MarkdownTextInput Variant="Variant.Outlined" Lines="3" Label="Explanation E (Markdown)" @bind-Value="Question.ExplanationE" />
                </div>
            </div>
        </div>
        <button class="btn btn-primary" type="submit">Done</button>
    </EditForm>
}

@code {

    public Question Question{ get; set; } = new();
    [Parameter]
    public int id { get; set; } = 0;
    [Parameter]
    public int topicId { get; set; } = 0;
    bool myBool;

    private Snackbar snackbar;

    private IEnumerable<Topic> Topics { get; set; } = Enumerable.Empty<Topic>();
    private IEnumerable<Course> Courses { get; set; } = Enumerable.Empty<Course>();


    protected async override Task OnInitializedAsync()
    {
        Courses = await repository.GetCourses();
    }

    [Inject]
    public NavigationManager NavManager { get; set; }

    protected async override Task OnParametersSetAsync()
    {
        if (id != 0)
        {
            Question = await repository.GetQuestion(id) ?? new();
        }
        else
            return;

        if (topicId != 0)
        {
            this.Question = new();
            Question.TopicRef = topicId;
        }
    }

    private async Task GetCourseTopics(ChangeEventArgs e)
    {
        Topics = await repository.GetTopics(e.Value.ToString());
        StateHasChanged();
    }

    private async Task SaveChanges()
    {
        if (id == 0)
        {
            try
            {
                var success = await repository.PostQuestion(Question); // Assuming PostQuestion returns a bool indicating success
                if (success)
                {
                    snackbar = Snackbar.Add("Question posted successfully!", Severity.Success);
                    ClearFields();
                }
                else
                {
                    snackbar = Snackbar.Add("Failed to post question. Please try again.", Severity.Warning);
                }
            }
            catch (Exception ex)
            {
                snackbar = Snackbar.Add($"An error occurred: {ex.Message}", Severity.Error);
            }
        }
        else
        {
            try
            {
                var success = await repository.UpdateQuestion(id, Question); // Assuming UpdateQuestion returns a bool indicating success
                if (success)
                {
                    snackbar = Snackbar.Add("Question updated successfully!", Severity.Success);
                }
                else
                {
                    snackbar = Snackbar.Add("Failed to update question. Please try again.", Severity.Warning);
                }
            }
            catch (Exception ex)
            {
                snackbar = Snackbar.Add($"An error occurred: {ex.Message}", Severity.Error);
            }
        }
    }

    private void ClearFields()
    {
        Question.QuestionMain = string.Empty;
        Question.ChildA = string.Empty;
        Question.ChildB = string.Empty;
        Question.ChildC = string.Empty;
        Question.ChildD = string.Empty;
        Question.ChildE = string.Empty;
        Question.ExplanationA = string.Empty;
        Question.ExplanationB = string.Empty;
        Question.ExplanationC = string.Empty;
        Question.ExplanationD = string.Empty;
        Question.ExplanationE = string.Empty;
    }
}

           